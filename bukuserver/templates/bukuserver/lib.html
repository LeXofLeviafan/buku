{% macro filter(name, value) %}{{ url_for('bookmark.index_view', **{'flt0_'+name: value}) }}{% endmacro %}

{% macro bookmarklet() -%}
  {% with url = url_for('bookmarklet', _external=True) -%}
    {% include 'bukuserver/bookmarklet.url' %}
  {%- endwith %}
{%- endmacro %}

{% macro script(filename) %}
  <script src="{{ url_for('static', filename='bukuserver/js/'+filename) }}"></script>
{% endmacro %}

{% macro close_if_popup() %}
  <script>opener && (opener !== window) && close()</script>
{% endmacro %}

{% macro limit_navigation_if_popup() %}
  <style>
    .popup .navbar-brand {pointer-events: none}
    .popup #admin-navbar-collapse {display: block}
    .popup :is(.navbar-nav, .navbar-toggler) {display: none}
    .popup .nav-tabs :is(:first-child, :nth-child(2)) > .nav-link:not(.active) {display: none}
  </style>
  <script>opener && (opener !== window) && document.body.classList.add('popup')</script>
{% endmacro %}

{% macro focus(location='body') %}
  {% if location %}
  <script>setTimeout(() => $('{{location|safe}} input:not([type=hidden])')[0]?.focus(), 500)</script>
  {% else %}
  <script>$(document).ready(() => document.activeElement?.blur())</script>
  {% endif %}
{% endmacro %}

{% macro fetch_checkbox(checked=True, modal=False) %}
  <script>
    $('.admin-form [name=fetch]').remove();
    $('.admin-form fieldset{% if modal %} .modal-footer{% endif %}').{% if modal %}prepend{% else %}append{% endif %}(
      $(`<div class="form-group {{ 'mb-0' if modal else '' }}"{% if modal %} style="flex-grow: 1"{% endif %}>`
        +`<label class="control-label {{ 'mb-0' if modal else '' }}">{{ _gettext('Fetch') }} &nbsp; </label>`
        +`<input type="checkbox" name="fetch"{% if checked %} checked{% endif %}></div>`));
  </script>
{% endmacro %}

{% macro horizontal_form(excluding_popups=False) %}
  <script>
    $('.admin-form .form-group').each(function () {
      if ($('.submit-row', this).length > 0{% if excluding_popups %} || document.body.matches('.popup'){% endif %}) {
        $('.submit-row', this).addClass(document.body.matches('.popup') ? 'col-md-12' : 'offset-md-2');
      } else if ($('input[type=checkbox], input[type=radio]', this).length > 0) {
        $('label', this).addClass('form-row').css({cursor: 'pointer'}).html(`<span>${ $('label', this).html() }</span>`);
        $('label span', this).addClass('col-md-2 col-form-label text-right d-inline-block');
        $('input', this).appendTo($('label', this));
      } else {
        $(this).addClass('form-row');
        $('input, textarea, select', this).addClass('col-md-10');
        $('label', this).addClass('col-md-2 col-form-label text-right');
      }
    });
  </script>
{% endmacro %}

{% macro details_formatting(prefix='') %}
  <script>
    $(`.modal-header h3`).wrapInner('<h5 class="modal-title">').children(0).unwrap();  // flask-admin #2505
    $(`body.popup {{prefix}} a`).attr('target', '_blank');
  </script>
{% endmacro %}

{% macro link_saved() %}
  {% set backlink = request.args.get('url', request.full_path) %}
  {% set saved = session.pop('saved', None) %}
  {% if saved %}
  <script>{
    const SUCCESS = [{{ _gettext('Record was successfully created.') | tojson }},
                     {{ _gettext('Record was successfully saved.') | tojson }}];
    $(`.alert-success`).filter((idx, e) => SUCCESS.some(s => e.innerText.includes(s))).html((_, s) =>
      s.replace(/(<\/button>)([^]*)$/, `$1<a href="{{ url_for('.details_view', id=saved, url=backlink) }}">$2</a>`));
  }</script>
  {% endif %}
{% endmacro %}
